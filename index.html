<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive University Guide for IB Students</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF8;
            color: #4A4A4A;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            height: 400px;
            max-height: 50vh;
        }
        .card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .chatbot-bubble {
            max-width: 80%;
            padding: 12px;
            border-radius: 1.25rem;
            margin-bottom: 8px;
            word-wrap: break-word;
        }
        .user-bubble {
            background-color: #E6E6E6;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }
        .gemini-bubble {
            background-color: #D1C7BC;
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #FDFBF8; }
        ::-webkit-scrollbar-thumb { background: #BCAE9F; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #8C7B6C; }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-[#6D5D4D]">University Explorer</h1>
            <p class="text-lg text-[#8C7B6C] mt-2">An Interactive Guide for Ambitious IB Students</p>
        </header>

        <section id="filters" class="bg-white rounded-xl shadow-md p-6 mb-8 sticky top-4 z-10 border border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div>
                    <label for="region-filter" class="block text-sm font-medium text-[#6D5D4D] mb-1">Region</label>
                    <select id="region-filter" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-[#BCAE9F] focus:border-[#BCAE9F] block p-2.5">
                        <option value="all">All Regions</option>
                        <option value="USA">USA</option>
                        <option value="Europe">Europe</option>
                    </select>
                </div>
                <div>
                    <label for="program-filter" class="block text-sm font-medium text-[#6D5D4D] mb-1">Field of Study</label>
                    <select id="program-filter" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-[#BCAE9F] focus:border-[#BCAE9F] block p-2.5">
                        <option value="all">All Fields</option>
                        <option value="CS">Computer Science</option>
                        <option value="DS_AI">Data Science & AI</option>
                        <option value="BME">Biomedical Engineering</option>
                    </select>
                </div>
                <div class="md:col-span-2 lg:col-span-2">
                    <label for="ib-score-slider" class="block text-sm font-medium text-[#6D5D4D] mb-1">My Target IB Score: <span id="ib-score-value" class="font-bold">45</span></label>
                    <input id="ib-score-slider" type="range" min="30" max="45" value="45" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>
        </section>

        <main>
            <div class="text-center mb-6">
                <p id="results-count" class="text-lg text-[#8C7B6C]"></p>
            </div>
            <div id="university-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>
        </main>

        <section id="visualizations" class="mt-16">
            <h2 class="text-3xl font-bold text-center text-[#6D5D4D] mb-4">Comparative Analysis</h2>
            <p class="text-center text-[#8C7B6C] mb-8 max-w-3xl mx-auto">The charts below dynamically update based on your filtered selection. They provide a powerful way to compare universities on key metrics like academic competitiveness and overall cost.</p>
            <div class="bg-white rounded-xl shadow-md p-6 mb-8 border border-gray-200">
                <h3 class="text-xl font-semibold text-[#6D5D4D] mb-2 text-center">IB Score Requirements: Minimum vs. Average Admitted</h3>
                <p class="text-center text-sm text-[#8C7B6C] mb-4">This chart reveals the significant difference between a university's official minimum required score and the average score of students who are actually admitted. Use this to gauge the true competitiveness of each institution.</p>
                <div class="chart-container">
                    <canvas id="ibScoreChart"></canvas>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
                 <h3 class="text-xl font-semibold text-[#6D5D4D] mb-2 text-center">Estimated Annual Cost: Tuition vs. Living Expenses</h3>
                 <p class="text-center text-sm text-[#8C7B6C] mb-4">Understand the full financial picture. This chart breaks down the estimated annual cost into tuition fees and living expenses, highlighting the different cost structures between universities, particularly between the US and Europe.</p>
                <div class="chart-container">
                    <canvas id="costChart"></canvas>
                </div>
            </div>
        </section>
    </div>

    <button id="chatbot-toggle" class="fixed bottom-6 right-6 p-4 rounded-full bg-[#BCAE9F] text-white shadow-lg focus:outline-none focus:ring-2 focus:ring-[#6D5D4D] transition duration-300 hover:scale-110">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
    </button>
    
    <div id="chatbot-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col">
            <div class="p-4 flex justify-between items-center border-b border-gray-200 bg-[#D1C7BC] rounded-t-xl">
                <h3 class="text-lg font-bold text-[#6D5D4D]">Academic Advisor Bot âœ¨</h3>
                <button id="chatbot-close" class="text-gray-600 hover:text-gray-800">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="chatbot-messages" class="flex-1 p-4 overflow-y-auto space-y-2">
                <div class="chatbot-bubble gemini-bubble text-sm">Hello! I'm your Academic Advisor Bot. How can I help you with your university search or IB program questions?</div>
            </div>
            <div class="p-4 border-t border-gray-200">
                <div class="flex">
                    <input id="chatbot-input" type="text" placeholder="Ask me anything..." class="flex-1 p-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-[#BCAE9F]">
                    <button id="chatbot-send" class="px-4 bg-[#BCAE9F] text-white rounded-r-lg hover:bg-[#A99F94] transition duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div id="modal-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto relative">
            <button id="modal-close" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div id="modal-body" class="p-8">
            </div>
        </div>
    </div>

    <script>
        const API_KEY = AIzaSyCKwlek2rAIWvXCtFMJwaTUFp8Hnw1Gizs;
        const universityData = [
            { id: 1, name: "MIT", region: "USA", country: "USA", fields: ["CS", "DS_AI", "BME"], ib_min: 39, ib_avg: 43, cost_tuition: 71291, cost_living: 30000, details: "A global leader in CS and AI research. Admission is holistic, but academic standards are exceptionally high. Offers world-class research opportunities at CSAIL. Famously need-blind with full-need financial aid for all undergraduates, making it potentially tuition-free for many.", recommended_courses: "HL: Math AA, Physics, Computer Science. SL: English B, Biology." },
            { id: 2, name: "Stanford University", region: "USA", country: "USA", fields: ["CS", "DS_AI", "BME"], ib_min: 39, ib_avg: 43, cost_tuition: 65000, cost_living: 41000, details: "Located in Silicon Valley, offering strong theoretical foundations and practical applications. The new B.S. in Data Science is explicitly interdisciplinary, blending tech with social sciences and ethics.", recommended_courses: "HL: Math AA, Physics, Computer Science. SL: English B, History." },
            { id: 3, name: "Carnegie Mellon", region: "USA", country: "USA", fields: ["CS", "DS_AI"], ib_min: 30, ib_avg: 43, cost_tuition: 83790, cost_living: 35116, details: "Renowned for its School of Computer Science and a pioneer in AI and robotics. Offers a dedicated B.S. in Artificial Intelligence. While the minimum IB score is low, the average for admitted students is exceptionally high, reflecting extreme selectivity.", recommended_courses: "HL: Math AA, Computer Science, Physics. SL: English B, Chemistry." },
            { id: 4, name: "Johns Hopkins", region: "USA", country: "USA", fields: ["BME", "DS_AI"], ib_min: 37, ib_avg: 44, cost_tuition: 73337, cost_living: 25000, details: "The top-ranked biomedical engineering program in the US for over 30 years. The unique BME 2.0 curriculum features a seven-semester design program where students work with clinicians on real-world healthcare challenges.", recommended_courses: "HL: Math AA, Physics, Chemistry, Biology." },
            { id: 5, name: "UC Berkeley", region: "USA", country: "USA", fields: ["BME", "DS_AI"], ib_min: 37, ib_avg: 40, cost_tuition: 51204, cost_living: 28000, details: "A top-ranked public university with an interdisciplinary Bioengineering program. Offers a dual-degree option with Business Administration for those interested in health entrepreneurship.", recommended_courses: "HL: Physics, Math AA, Biology, Chemistry." },
            { id: 6, name: "Georgia Tech", region: "USA", country: "USA", fields: ["CS", "DS_AI", "BME"], ib_min: 30, ib_avg: 38, cost_tuition: 33596, cost_living: 24796, details: "Offers excellent value for an elite public education. The BME program, in collaboration with Emory University, focuses on hands-on problem-solving. Strong co-op and internship programs provide real-world experience.", recommended_courses: "HL: Math AA, Physics, Chemistry." },
            { id: 7, name: "ETH Zurich", region: "Europe", country: "Switzerland", fields: ["CS", "DS_AI"], ib_min: 38, ib_avg: 40, cost_tuition: 1608, cost_living: 22500, details: "A top technical university in Europe with a reputation for rigor. Admissions are highly formulaic, requiring a minimum of 38/42 points AND a 6 in both HL Math and Physics. Tuition is low but set to triple for non-residents in 2025.", recommended_courses: "HL: Math (AA/AI), Physics, Language A. SL: Three from an approved list." },
            { id: 8, name: "EPFL", region: "Europe", country: "Switzerland", fields: ["CS", "DS_AI", "BME"], ib_min: 38, ib_avg: 40, cost_tuition: 1460, cost_living: 18000, details: "One of Europe's most cosmopolitan technical universities. Admission criteria are very similar to ETH Zurich (38/42 points with a 6 in HL Math & Physics). B2 level French proficiency is also required.", recommended_courses: "HL: Math (AA/AI), Physics, and one of Chemistry, Biology, or CS." },
            { id: 9, name: "Imperial College", region: "Europe", country: "UK", fields: ["CS", "BME"], ib_min: 41, ib_avg: 42, cost_tuition: 35000, cost_living: 22000, details: "A premier UK technical institution with rigorous standards. The MEng in Biomedical Engineering has strong industrial links. Requires a high total of 41 points, including a 7 in HL Mathematics.", recommended_courses: "HL: Math AA (must score 7), and another relevant science subject." },
            { id: 10, name: "IE University", region: "Europe", country: "Spain", fields: ["CS", "DS_AI"], ib_min: 24, ib_avg: 36, cost_tuition: 23000, cost_living: 10000, details: "A unique private university blending business, technology, and an entrepreneurial ethos. Known for its international diversity and practical, project-based learning. The average admitted IB score is 36.", recommended_courses: "HL/SL: Math AA or Math AI HL is required for tech programs." },
            { id: 11, name: "TU Delft", region: "Europe", country: "Netherlands", fields: ["CS", "DS_AI"], ib_min: 32, ib_avg: 34, cost_tuition: 4000, cost_living: 10000, details: "A high-caliber technical university with a focus on practical skills. A standard IB Diploma is not sufficient for direct entry; applicants must first complete one year of a relevant university program elsewhere.", recommended_courses: "N/A for direct entry from IB." },
            { id: 12, name: "Politecnico di Milano", region: "Europe", country: "Italy", fields: ["CS", "DS_AI"], ib_min: 27, ib_avg: 30, cost_tuition: 4000, cost_living: 9000, details: "A highly-ranked public Italian university with high graduate employment rates. Offers specialized Master's tracks in Big Data and Data Science. The academic environment is known to be demanding.", recommended_courses: "A strong background in Math and Physics is expected." }
        ];

        const fieldMap = {
            "CS": "Computer Science",
            "DS_AI": "Data Science and AI",
            "BME": "Biomedical Engineering"
        };

        const regionFilter = document.getElementById('region-filter');
        const programFilter = document.getElementById('program-filter');
        const ibSlider = document.getElementById('ib-score-slider');
        const ibValue = document.getElementById('ib-score-value');
        const grid = document.getElementById('university-grid');
        const resultsCount = document.getElementById('results-count');
        
        const modal = document.getElementById('modal');
        const modalClose = document.getElementById('modal-close');
        const modalBody = document.getElementById('modal-body');

        const chatbotToggle = document.getElementById('chatbot-toggle');
        const chatbotModal = document.getElementById('chatbot-modal');
        const chatbotClose = document.getElementById('chatbot-close');
        const chatbotMessages = document.getElementById('chatbot-messages');
        const chatbotInput = document.getElementById('chatbot-input');
        const chatbotSend = document.getElementById('chatbot-send');

        let ibScoreChart, costChart;
        let chatHistory = [];

        async function callGeminiAPI(prompt, retries = 3, delay = 1000) {
            try {
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }]
                };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error('Invalid API response structure');
                }
            } catch (error) {
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return callGeminiAPI(prompt, retries - 1, delay * 2);
                } else {
                    console.error("Gemini API call failed after multiple retries:", error);
                    throw error;
                }
            }
        }

        async function callChatGeminiAPI(prompt, retries = 3, delay = 1000) {
            try {
                const payload = {
                    contents: chatHistory.concat([{ role: "user", parts: [{ text: prompt }] }])
                };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error('Invalid API response structure');
                }
            } catch (error) {
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return callChatGeminiAPI(prompt, retries - 1, delay * 2);
                } else {
                    console.error("Gemini Chat API call failed after multiple retries:", error);
                    throw error;
                }
            }
        }
        
        function createIBScoreChart(data) {
            const ctx = document.getElementById('ibScoreChart').getContext('2d');
            if (ibScoreChart) {
                ibScoreChart.destroy();
            }
            ibScoreChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(u => u.name),
                    datasets: [
                        {
                            label: 'Minimum IB Score',
                            data: data.map(u => u.ib_min),
                            backgroundColor: 'rgba(188, 174, 159, 0.6)',
                            borderColor: 'rgba(188, 174, 159, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Average Admitted IB Score',
                            data: data.map(u => u.ib_avg),
                            backgroundColor: 'rgba(109, 93, 77, 0.8)',
                            borderColor: 'rgba(109, 93, 77, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 25,
                            title: { display: true, text: 'IB Score (out of 45)' }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: (context) => context[0].label,
                                label: (context) => `${context.dataset.label}: ${context.raw}`
                            }
                        }
                    }
                }
            });
        }

        function createCostChart(data) {
            const ctx = document.getElementById('costChart').getContext('2d');
            if (costChart) {
                costChart.destroy();
            }
            costChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(u => u.name),
                    datasets: [
                        {
                            label: 'Tuition',
                            data: data.map(u => u.cost_tuition),
                            backgroundColor: 'rgba(209, 199, 188, 0.7)',
                            borderColor: 'rgba(209, 199, 188, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Living Expenses',
                            data: data.map(u => u.cost_living),
                            backgroundColor: 'rgba(140, 123, 108, 0.7)',
                            borderColor: 'rgba(140, 123, 108, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true },
                        y: { 
                            stacked: true,
                            title: { display: true, text: 'Estimated Annual Cost (USD)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000) + 'k';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderCards(data) {
            grid.innerHTML = '';
            if (data.length === 0) {
                grid.innerHTML = `<p class="text-center text-gray-500 md:col-span-2 lg:col-span-3">No universities match your criteria. Try adjusting the filters.</p>`;
                resultsCount.textContent = 'Showing 0 universities.';
                return;
            }
            
            resultsCount.textContent = `Showing ${data.length} of ${universityData.length} universities.`;

            data.forEach(uni => {
                const card = document.createElement('div');
                card.className = 'card bg-white rounded-xl shadow-sm p-6 border border-gray-200 cursor-pointer';
                card.dataset.id = uni.id;
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="text-xl font-bold text-[#6D5D4D]">${uni.name}</h3>
                        <span class="text-sm font-medium ${uni.region === 'USA' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'} px-2.5 py-0.5 rounded-full">${uni.region}</span>
                    </div>
                    <p class="text-sm text-gray-500 mb-4">${uni.country}</p>
                    <div class="space-y-3 text-sm">
                        <div class="flex items-center">
                            <span class="w-6 text-center mr-2">ðŸŽ¯</span>
                            <div><strong>Avg. Admitted IB:</strong> ${uni.ib_avg}</div>
                        </div>
                        <div class="flex items-center">
                            <span class="w-6 text-center mr-2">ðŸ’°</span>
                            <div><strong>Total Est. Cost:</strong> $${(uni.cost_tuition + uni.cost_living).toLocaleString()}/year</div>
                        </div>
                        <div class="flex items-center">
                            <span class="w-6 text-center mr-2">ðŸ”¬</span>
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${uni.fields.map(f => `<span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded-md">${fieldMap[f]}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
                card.addEventListener('click', () => showModal(uni.id));
                grid.appendChild(card);
            });
        }
        
        function showModal(id) {
            const uni = universityData.find(u => u.id === id);
            if (!uni) return;
            
            modalBody.innerHTML = `
                <div class="flex flex-col md:flex-row gap-8">
                    <div class="flex-1">
                        <h2 class="text-3xl font-bold text-[#6D5D4D]">${uni.name}</h2>
                        <p class="text-md text-gray-500 mb-4">${uni.country}, ${uni.region}</p>
                        <div class="flex flex-wrap gap-2 mb-6">
                            ${uni.fields.map(f => `<span class="text-sm bg-gray-200 text-gray-800 font-medium px-3 py-1 rounded-full">${fieldMap[f]}</span>`).join('')}
                        </div>
                        <div class="mb-4">
                            <p id="program-description-content" class="text-base leading-relaxed text-gray-700">${uni.details}</p>
                            <button id="generate-program-details" class="mt-4 px-4 py-2 bg-[#BCAE9F] text-white rounded-lg hover:bg-[#A99F94] transition duration-200">
                                Generate a detailed description âœ¨
                            </button>
                            <span id="loading-description" class="hidden ml-4 text-sm text-[#8C7B6C]">Generating...</span>
                        </div>
                    </div>
                    <div class="w-full md:w-1/3 bg-[#FDFBF8] p-6 rounded-lg border">
                        <h4 class="font-bold text-lg mb-4 text-[#6D5D4D]">Key Information</h4>
                        <div class="space-y-4 text-sm">
                            <div>
                                <p class="font-semibold">IB Score (Avg. Admitted)</p>
                                <p class="text-2xl font-bold text-[#6D5D4D]">${uni.ib_avg} <span class="text-base font-normal text-gray-500"> (min: ${uni.ib_min})</span></p>
                            </div>
                            <div>
                                <p class="font-semibold">Est. Annual Tuition</p>
                                <p class="text-lg text-gray-800">$${uni.cost_tuition.toLocaleString()}</p>
                            </div>
                            <div>
                                <p class="font-semibold">Est. Annual Living Costs</p>
                                <p class="text-lg text-gray-800">$${uni.cost_living.toLocaleString()}</p>
                            </div>
                             <div>
                                <p class="font-semibold">Recommended IB HL Courses</p>
                                <p class="text-gray-800">${uni.recommended_courses}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            const generateButton = document.getElementById('generate-program-details');
            const descriptionContent = document.getElementById('program-description-content');
            const loadingIndicator = document.getElementById('loading-description');

            generateButton.addEventListener('click', async () => {
                const programName = uni.fields.map(f => fieldMap[f]).join(" and ");
                const prompt = `Act as a university admissions expert. Write a detailed, engaging, and professional description of the ${uni.name}'s program for ${programName}. Focus on unique aspects, research opportunities, and academic culture. The response should be concise and around 200 words.`;
                
                loadingIndicator.classList.remove('hidden');
                generateButton.disabled = true;

                try {
                    const generatedText = await callGeminiAPI(prompt);
                    descriptionContent.textContent = generatedText;
                } catch (error) {
                    descriptionContent.textContent = "Sorry, I couldn't generate a description at this time. Please try again later.";
                } finally {
                    loadingIndicator.classList.add('hidden');
                    generateButton.disabled = false;
                }
            });
        }

        function addMessageToChat(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.className = `chatbot-bubble text-sm ${sender === 'user' ? 'user-bubble' : 'gemini-bubble'}`;
            messageElement.textContent = text;
            chatbotMessages.appendChild(messageElement);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        }

        async function sendMessage() {
            const userInput = chatbotInput.value.trim();
            if (!userInput) return;

            addMessageToChat(userInput, 'user');
            chatbotInput.value = '';
            
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'chatbot-bubble gemini-bubble text-sm text-gray-500';
            typingIndicator.innerHTML = 'Thinking...';
            chatbotMessages.appendChild(typingIndicator);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;

            try {
                const responseText = await callChatGeminiAPI(userInput);
                chatHistory.push({ role: "user", parts: [{ text: userInput }] });
                chatHistory.push({ role: "model", parts: [{ text: responseText }] });
                
                chatbotMessages.removeChild(typingIndicator);
                addMessageToChat(responseText, 'gemini');
            } catch (error) {
                chatbotMessages.removeChild(typingIndicator);
                addMessageToChat("Sorry, I'm having trouble connecting right now. Please try again later.", 'gemini');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const regionFilter = document.getElementById('region-filter');
            const programFilter = document.getElementById('program-filter');
            const ibSlider = document.getElementById('ib-score-slider');
            const ibValue = document.getElementById('ib-score-value');

            function applyFilters() {
                const region = regionFilter.value;
                const program = programFilter.value;
                const ibScore = parseInt(ibSlider.value, 10);

                const filteredData = universityData.filter(uni => {
                    const regionMatch = region === 'all' || uni.region === region;
                    const programMatch = program === 'all' || uni.fields.includes(program);
                    const ibMatch = uni.ib_avg <= ibScore;
                    return regionMatch && programMatch && ibMatch;
                });

                renderCards(filteredData);
                
                const chartData = filteredData.slice(0, 10);
                createIBScoreChart(chartData);
                createCostChart(chartData);
            }

            ibSlider.addEventListener('input', (e) => {
                ibValue.textContent = e.target.value;
            });
            
            ibSlider.addEventListener('change', applyFilters);
            regionFilter.addEventListener('change', applyFilters);
            programFilter.addEventListener('change', applyFilters);

            modalClose.addEventListener('click', () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }
            });

            chatbotToggle.addEventListener('click', () => {
                chatbotModal.classList.remove('hidden');
                chatbotModal.classList.add('flex');
            });

            chatbotClose.addEventListener('click', () => {
                chatbotModal.classList.add('hidden');
                chatbotModal.classList.remove('flex');
            });

            chatbotSend.addEventListener('click', sendMessage);
            chatbotInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            applyFilters();
        });
    </script>

</body>
</html>
